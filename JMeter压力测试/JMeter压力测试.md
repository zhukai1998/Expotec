# 压力测试 - JMeter
- [参考链接](https://www.cnblogs.com/Chamberlain/p/12287412.html)

## 前言
- 压力测试是每一个 Web 应用程序上线之前都需要做的一个测试，它可以帮助我们发现系统中的瓶颈问题，减少发布到生产环境后出现的几率；
预估系统的承载能力，使我们能根据其做出一些应对措施。

## JMeter
- Apache JMeter 是 Apache 组织开发的基于 Java 的压力测试工具。用于对软件做压力测试，它最初被设计用于 Web 应用测试，但后来拓展到其他测试领域。
它可以用于测试静态和动态资源，例如静态文件、Java 小服务程序、CGI 脚本、Java 对象、数据库、FTP 服务器等等。
- JMeter 可以用于对服务器、网络或对象模拟巨大的负载，来自不同压力类别下测试它们的强度和分析整体性能。另外，JMeter能够对应用程序做功能/回归测试，通过创建带有断言的脚本来验证你的程序返回了你期待的结果，为了最大限度的灵活性，JMeter允许使用正则表达式创建断言。
- 


# 接口测试部分

## 线程组
- 线程组：主要的业务的代码
- setUp 线程组：测试之前的需要做的所有的操作
- tearDown 线程组：测试之后需要的操作

- 比如，测试之前，去数据库里面添加一些准备数据（setUp 线程组），所有的用例测完后，数据库产生了大量的垃圾数据，需要恢复数据（tearDown 线程组）

## HTTP 请求

## 变量
- 在测试计划里面添加变量，引用时用${}
- 内容编码：utf8

## 上下游传参 
- 查看结果树 - JSON Path Tester - JSON Path Expression($["variable"])
- HTTP请求 - 添加 - 后置处理器 - JSON 提取器
- JSON 提取器
- Names of created variables 自定义名字（后续会用到）
- 把$["variable"] 放到 JSON 提取器的 JSON Path expressions
- Match No. 默认用 1 便可以
- HTTP 请求
- token 替换为${自定义名字}

## 内置函数
- 工具 - 函数助手对话框 
- 函数助手对话框
- 可选（RandomString）以其为例
- 随机字符串长度
- 字符库
- 生成
- 复制函数字符串至 HTTP 请求的消息体 JSON 对应处

## 正则表达式
- 查看结果树 - RegExp Tester（筛选？） - Regular expression：`“字段”:(.+?),`
- HTTP 请求 - 添加 - 正则表达式提取器
- 正则表达式提取器
- 引用名称：自定义
- 正则表达式：`“字段”:(.+?),`
- 模版：$1$
- 匹配数字：先前数据的下标
- HTTP 请求
- 字段替换为 ${自定义}

## 数据驱动 CSV 文件配置（批量造数据）
- csv 将表头名字填写到消息体${表头}
- 上传 csv
- 线程组 - 添加 - 配置元件 - CSV Data Set Config
- CSV Data Set Config
- 文件
- 变量名称（直接复制表头）
- 文件编码
- 首行忽略
- 线程组改一下线程

## 断言（服务器返回数据不对警示）
- 可添加多个响应断言，规则可叠加
- HTTP 请求 - 添加 - 断言 - 响应断言
- 响应断言
### 响应文本
- 模式匹配规则：字符串
- 测试模式：添加一个字段：`"字段"`

### 响应代码
- 模式匹配规则：相等
- 测试模式：状态码
- HTTP 请求 - 添加 - 断言 - JSON 断言
- JSON 断言
- Assert JSON Path exists：`$["字段"]`



# 202104141036更新
- [参考链接](https://www.cnblogs.com/Chamberlain/p/12287412.html)

## JMeter 基本介绍和使用场景

### 压测不同的协议和应用
- Web - HTTP, HTTPS(Java, NodeJS, PHP, ASP, .NET)
- SOAP / REST WebServices
- FTP
- Database via JDBC
- LDAP 轻量目录访问协议
- Message-oriented middleware(MOM) via JMS
- Mail - SMTP(S), POP3(S) and IMAP(S)
- TCP

### 使用场景及优点
- 功能测试
- 压力测试
- 分布式压力测试
- 纯 Java 开发
- 上手容易，高性能
- 提供测试数据分析
- 各种报表数据图形展示

### 安装
- 需要 JDK8 + 
- [文档地址](http://jmeter.apache.org/usermanual/get-started.html)
- 建议安装 JDK 环境，虽然 JRE 也可以，但是压测 Https 需要 JDK 里面的 keytool 工具

### 目录
- bin ： 核心可执行文件
· jmeter 启动文件
· jmeter-server 分布式压测使用的启动文件
· jmeter-properties 核心配置文件
- extras ： 插件拓展的包
- lib ： 核心的依赖包
- ext ： 核心包
- junit ： 单元测试包

## JMeter 核心组件讲解和实操
- JMeter 基础功能组件介绍线程组和 Sampler
- 添加 -- 线程 -- 线程组（控制总体并发）
· 线程数：虚拟用户数。一个虚拟用户占用一个进程或者线程
· 准备时长（Ramp-Up Period（in seconds））：全部线程启动的时长，比如100个线程，20秒，则表示20秒内100个线程都要启动完成，每秒启动5个线程
· 循环次数：每个线程发送的次数，假如值为5，100个线程，则会发送500次请求，可以勾选永远循环

- 线程组 -- 添加 -- Sampler（采样器） -- Http（一个线程组下面可以增加几个Sampler）
· 名称： 采样器名称
· 注释： 对这个采样器的描述
· web服务器：
· 默认协议 http
· 默认端口 80
· 服务器名称或IP：请求的目标服务器名称或IP地址
· 路径： 服务器 URL
· Use multipart/from-data for HTTP POST: 当发送 POST 请求时，使用 Use multipart/from-data 方法发送，默认不选中
- 查看测试结果
· 线程组 -- 添加 -- 监听器 -- 察看结果树
- JMeter的断言基本使用
- 增加断言：线程组 -- 添加 -- 断言 -- 响应断言
· apply to（应用范围）
· Main sample only：仅当前父取样器进行断言，一般一个请求，如果发一个请求会出发多个，则就有 sub sample
· 要测试的响应字段：
· 响应文本：即响应的数据，比如 json 等文本
· 响应代码：http 的响应状态码，比如200，302， 404
· 响应信息：http 响应代码对应的响应信息，例如：OK，Found
· Response Header：响应头
- 模式匹配规则
· 包括：包含在里面就成功
· 匹配：响应内容完全匹配，不区分大小写
· equals：完全匹配，区分大小写
- 断言结果监听器：线程组 -- 添加 -- 监听器 -- 断言结果
· 里面的内容是sampler采样器的名称
· 断言失败，查看结果树任务结果颜色标红（通过结果树里面双击不通过的记录，可以看到错误信息）
- 每个 sample 下面可以加单独的结果树，然后同事加多个断言，最外层可以加个结果树进行汇总


### JMeter实战之压测结果聚合报告分析
- 新增聚合报告：线程组 -- 添加 -- 监听器 -- 聚合报告
· lable：sample的名称
· Samples：一共发出去多少请求，例如 10 个用户，循环10次，则是100
· Average：平均响应时间
· Median：中位数：也就是50%用户的响应时间

90%Line：90%用户的响应不会超过该时间（90% of the samples took no more than this time. The remaining samples at least as long as this)
· 95%Line：95%用户的响应不会超过该时间
· 99%Line：99%用户的响应不会超过该时间
· min：最小响应时间
· max：最大响应时间

· Error%：错误的请求的数量/请求的总数
· Throughput：吞吐量--默认情况下表示每秒完成的请求数（Request per Second）可类比为 qps
· KB/Sec：每秒接收数据量

### JMeter压测脚本 JMX 讲解
- 打开方式 Sublime 或者 xml 编辑器
- 运行日志和压测事件查看

### 自定义变量和 CSV 可变参数实操
- JMeter 用户自定义变量实战
```
简介：什么是用户自定义变量，怎样使用
为什么使用：很多变量在全局中都有使用，或者测试数据更改，可以在一处定义，四处使用
比如说服务器地址
1、线程组 -- add -- Config Element（配置原件） -- User Definde Variable(用户定义的变量)
2、引用方式$(XXX)，在接口中变量中使用
3、原始查看结果树和非原生查看（基础按钮）
```
- JMeter 实战之 CSV 可变参数压测
```
简介：
实战操作 JMeter 读取 CSV 和 Txt 文本文件里面的参数进行压测
1、线程组 -- add -- Config Element（配置原件） -- CSV data set config（CSV 数据文件设置）
```
- CSV文件多参数使用
```
简介：在读取的配置文件里面，同时使用多个自定义参数
1、如果是多个参数需要同时引用，则在 CSV 数据文件里面设置加多个字段 Variabled names(comma-delitited):csv_name, csv_pwd

```

### Mysql 数据库压测实操
- JMeter 压测实战之 JDBC request 压测 Mysql 讲解
```
简介：讲解 JDBC 压测 Mysql 相关准备工作：jar 包添加，配置讲解
1、Thread Group -- add -- sampler -- JDBC request
2、jar 包添加 mysql-connector-java-5.1.30.jar
3、JDBC connection Configuration 配置
	1.JDBC request -- add -- config element -- JDBC connection configuration
		核心配置
			Max Number of connections：最大连接数
			Max wait：最大等待时间
			Auto Commit：是否自动提交事务
			DataBase URL：数据库连接地址 jdbc:mysql://127.0.0.1:3306/blog
			JDBC Driver Class: 数据库去哦那个，选择对应的 mysql
			username：数据库用户名
			password：数据库密码

 ```

 ### JMeter 压测实战之 JDBC request 压测 Mysql，select 语句
 ```
简介：使用 JMeter 压测 mysql，select，insert语句
1、Debug Sampler 使用（结果树中查看）：Thread Group -- add -- sampler -- debug sampler
2、参数讲解：（sql 结尾不要加；）
	1.variable name of pool decleared in JDBC connection configuration（和配置文件同名）
	2.Query Type查询类型
	3.parameter values 参数值
	4.parameter types 参数类型
	5.variable names sql 执行结果变量名
	6.result variable names 所有结果当作一个对象存储
	7.query timeouts 查询超时时间
	8.handle results 处理结果集

 ```

 ### 分布式压测介绍
 ```
简介：讲解什么是分布式压测
	普通压测：单台机可以对目标机器产生的压力比较小，受限因素包括 CPU，网络，IO等
	分布式压测：利用多台机器向目标机器产生压力，模拟几万用户并发访问
 ```

### JMeter分布式压测原理
```
简介：讲解 JMeter 分布式压测原理
1、总控机器的节点 master，其他产生压力的机器叫做“肉鸡” server
2、master 会把压测脚本发送到 server 上面
3、执行的时候，server 上只需要把 JMeter-server 打开就可以了，不用启动 JMeter
4、结束后，server 会把压测数据回传给 master，然后 master 汇总输出报告
5、配置详情
```

### 高级篇之阿里云 Linux 服务器压测接口实战
- SpringBoot 接口打包，并用 jar 包方式部署
```
简介：用 jar 包方式在控制台进行启动
	打包 mvn package && java -jar  target/gs-spring-boot-0.1.0.jar
```

### 阿里云服务器介绍和 ECS 服务器使用
```
简介：
	阿里云服务器介绍和购买 ECS 服务器等
	推荐购买 2G 内存以上的进行开发学习
```

### 部署 Java 项目到阿里云服务器和守护进程讲解
```
简介：
	部署项目到阿里云，并启动，公网可以访问
	1.注意点
		关闭防火墙
		阿里云控制台安全策略，开放端口
	linux 上运行 java -jar *****

	守护进程：nohup java -jar **** &
		什么是守护进程
```

### 阿里云压测 HTML 可视化压测报告




## 与测试相关的指标
- QPS：每秒查询数 -- 这个指标一般用在数据库上，不过很多人都会把这个和 TPS 混淆，这个知道是怎么回事便可以了
- TPS：每秒内的事务数 -- 执行多组操作的性能 -- 也是数据库的一个指标，不过我们可以把
- PV： 指的是调用次数
- RT： 接口的响应时间
- CPU使用率：
- CPU Loading 指数：这个指标比较重要，能反映出 CPU 当前的“疲劳程度”，当前 CPU 处理任务数量，一般最大都要保证内核数量 * 1.2
- 内存：
- 出向和入向流量：
- 低延迟
- 高吞吐

## 如何获得指标
- 使用常用的压测工具都可以，JMeter 等等，这类操作工具都会将 QPS 或者 TPS，RT 整理统计出来

## 如何真正地把机器的性能压出来，做一次完美的压测
- 去压测性能的真的是一个技术活，是一个慢慢试出来的过程

## 首先我们要做性能预估
- 面对一个集群，性能应该如何预估？
- 没别的办法，看经验，靠猜
- 但是也可以使用一些简单的方法，比如
1、由小到大，逐级测试 -- 用一个小的压力做初次预估，慢慢逼近性能极限
2、参照物法，逐渐逼近 -- 一组内公司内类似规模的系统，进行初次预估
3、玄学瞎猜，慢慢测试 -- 没有任何可以参考的就瞎猜一个吧，然后慢慢地去寻找

## 制定压力层级和对应的指标
- 在压测过程中性能 QPS/TPS 的随着压力的变化曲线应该是一个波浪状的
- 找出了预估的并发大小之后（一般是一个5的倍数的并发数），以这个为基准，增加多少并发，减少多少并发，列成表格，注意记录各种性能的指标
- PS：这里就有一些统计学的东西，比如中位数和平均值，其实在压测的时候中位数更能体现出 RT 这个指标的实际效果
注意：这个得出的性能（QPS/TPS）信息最后至少有一个下降的维度，是一个波浪状的效果，这样才能找到性能的极限
注意：最终性能要使用有效数据，如果 RT 超过限制或者 CPU Loading 超过了限制，那么这个数据认为不达标，但是这个可以用作统计分析

## 性能瓶颈定位
- 影响性能的原因有多种，不一定真的是系统本身的问题
通过上面的制定压力层级和对应的指标，我们已经可以确定了我们当前场景下的一个最佳性能了，接下来就需要进行性能问题排查调优

- 瓶颈排查：
1、排查日志，找到耗时过长逻辑，定位分析，比如 Java 系的系统可以使用 阿里开源的在线性能分析工具 arthas
2、排查网络问题：当确认代码逻辑没有问题的时候，网络延迟过高也会影响 QPS，比如跨机房调用等，这个时候需要找运维同学协助解决，做部署迁移，搭建专用线路等方法
3、最后 CPU 瓶颈：这个时候只能通过加机器解决

- 性能调优
这个步骤就很多了，要针对自己的技术栈进行操作，比如 Java 可修改 JVM 参数，看一下 JVM GC，内存状态，分别对应的进行一下调优

## 性能瓶颈定位 - 其他方面
- QPS 上不去问题可能并不是后台的事情，不同类型的系统间的相互调用也可能会导致性能问题
随着现在互联网架构的升级 epoll 模式的广泛应用，系统之间的调用也可能成为性能的瓶颈

- 传统 Java 线程体系是一个典型的低延迟系统，因为线程模型是独立执行的不会正常理想情况下不会中途终止执行（线程上下文切换），所以说一个任务执行完成的时间就是这个任务执行在 CPU 中的最短时间
- Golang/Nodejs是高吞吐系统，应为底层用 epoll 模型 使用事件轮询，其实本质上是将多个任务分配到一个线程中去执行，也就是说一个任务执行完的时间近似等于这一个线程所有任务完成的平均时间

上面介绍完了 -- 引出重点，上面的两个系统如果 Java 去调用 Golang 或者 Nodejs系统的话，Java就会出现性能问题

因为 Java 在线程模型下，要能保证高的性能必须保证延迟要足够低，否则会导致线程过多，线程上下文切换频繁，结果拉低整个性能，但是 Golang/Nodejs 只是保证的吞吐 QPS 没有保证延迟 RT 所以，会导致底层服务性能很好吞吐量高但是上层服务怎么优化都没有办法实现高并发。

如何解决？？
Java 抛弃线程模型使用 NIO，应为针对会联网应用在延迟可控的情况下应该尽可能地追求吞吐量，但是 Java NIO 模型需要写异步回调，这会导致开发效率降低，权衡下来，Java 增加机器来解决


## 性能瓶颈定位 - 压测的时候压力机器也要注意，有的时候瓶颈可能是压力机器的
如果我们只是使用一台压力机器进行压测是片面的，因为网络的开销/延迟，都能影响到压力机器对该测试机器的负载，也就是说压力机器到了上限但是测试机器还没有到压测上限
解决方法：使用集群进行压力测试

## 最后
- 这里只是记录了单个业务的压测方法，其实现在架构中还有针对于整个调用链路的压测
- 全链路压测，其实是这种单业务压测的泛化场景，需要调动各个部门，各个系统的开发人员一起做性能压测，技术上的操作和单业务压测是类似的，只是多了一些调用链路性能指标，各个系统之间调用的性能记录，还有一些故障演练，其实全链路更考验我们的组织能力，团队协作和沟通交流能力

- [参考链接](https://zhuanlan.zhihu.com/p/117310105)












